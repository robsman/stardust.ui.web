(function(e,t){if(typeof define==="function"&&define.amd){define(["jquery"],t)}else{t(jQuery)}})(this,function(e){e(document).on("mobileinit",function(){var t=e.extend({fixFirstPageDataUrl:false,firstPageDataUrl:"index.html",ajaxApp:false,firstMatchOnly:false,defaultArgsRe:false},e.mobile.jqmRouter||{});var n=null,r=null,i=false;e(document).on("pagebeforechange",function(t,s){if(s.options.hasOwnProperty("_jqmrouter_handled")){return}var o;if(typeof s.toPage==="string"){o=s.toPage}else{o=s.toPage.jqmData("url")||"";if(s.toPage.attr("id")==o){o="#"+o}}s.options._jqmrouter_handled=true;if(s.options.data&&(s.options.type+"").toLowerCase()=="get"){o+="?"+s.options.data}var u=e.mobile.path.parseUrl(o);n=r;r=u;if(u.hash.indexOf("?")!=-1){s.options.dataUrl=u.hash.replace(/^#/,"")}var a=/^#|\?.*$/g;if(n&&u.hash!=n.hash&&u.hash.replace(a,"")==n.hash.replace(a,"")){s.options.allowSamePageTransition=true&&!i}i=false;if(window.location.hash.indexOf("&ui-state=dialog")!=-1){i=true}});if(t.fixFirstPageDataUrl){e(document).ready(function(){if(!window.location.pathname.match("/$")){return}var n=e(":jqmData(role='page')").first();var r=n.jqmData("url"),i=window.location.pathname+t.firstPageDataUrl+window.location.search+window.location.hash;if(r!=i){n.attr("data-url",i).jqmData("url",i)}})}e.mobile.Router=function(n,r,i){this.routes={pagebeforecreate:null,pagecreate:null,pagebeforeshow:null,pageshow:null,pagebeforehide:null,pagehide:null,pageinit:null,pageremove:null,pagebeforechange:null,pagebeforeload:null,pageload:null,popupbeforeposition:null,popupafteropen:null,popupafterclose:null};this.evtLookup={bC:"pagebeforechange",bl:"pagebeforeload",l:"pageload",bc:"pagebeforecreate",c:"pagecreate",bs:"pagebeforeshow",s:"pageshow",bh:"pagebeforehide",h:"pagehide",i:"pageinit",rm:"pageremove",pbp:"popupbeforeposition",pao:"popupafteropen",pac:"popupafterclose"};this.routesRex={};this.conf=e.extend({},t,i||{});this.defaultHandlerEvents={};if(this.conf.defaultHandlerEvents){var s=this.conf.defaultHandlerEvents.split(",");for(var o=0;o<s.length;o++){this.defaultHandlerEvents[this.evtLookup[s[o]]]=s[o]}}this.add(n,r)};e.extend(e.mobile.Router.prototype,{documentEvts:{pagebeforechange:1,pagebeforeload:1,pageload:1},debug:function(e){var t=this.conf;if(t.debugHandler){t.debugHandler.apply(this,arguments)}else if(t.debugHandler!==false&&typeof console!="undefined"&&console.log){console.log.apply(console,arguments);if(e.stack){console.log(e.stack)}}},add:function(t,n,r){if(!t){return}var i=this,s=[],o=[];if(t instanceof Array){e.each(t,e.proxy(function(e,t){this.add(t,n,true)},this))}else{e.each(t,function(e,t){if(typeof t=="string"||typeof t=="function"){if(i.routes.pagebeforeshow===null){i.routes.pagebeforeshow={}}if(i.conf.defaultArgsRe){e+="(?:[?](.*))?$"}i.routes.pagebeforeshow[e]={handler:t,events:"bs"};if(!i.routesRex.hasOwnProperty(e)){i.routesRex[e]=new RegExp(e)}}else{var n,r=t.events.split(","),s;if(t.argsre!==false&&(t.argsre||i.conf.defaultArgsRe)){e+="(?:[?](.*))?$"}for(n=0;n<r.length;n++){s=i.evtLookup[r[n]];if(i.routes.hasOwnProperty(s)){if(i.routes[s]===null){i.routes[s]={}}i.routes[s][e]=t;if(!i.routesRex.hasOwnProperty(e)){i.routesRex[e]=new RegExp(e)}}else{i.debug("can't set unsupported route "+r[n])}}}})}if(r===true){return}if(!this.userHandlers){this.userHandlers=n||{}}else{e.extend(this.userHandlers,n||{})}e.each(i.routes,function(e,t){if(t!==null){if(!i.documentEvts[e]){s.push(e)}else{o.push(e)}}});this._detachEvents();var u=function(e,t){i._processRoutes(e,t,this)};if(s.length>0){this._eventData={events:s.join(" "),selectors:":jqmData(role='page'),:jqmData(role='dialog')",handler:u};e(document).on(this._eventData.events,this._eventData.selectors,this._eventData.handler)}if(o.length>0){this._docEventData={events:o.join(" "),handler:u};e(document).on(this._docEventData.events,this._docEventData.handler)}},_processRoutes:function(t,i,s){var o=this,u,a,f=0,l=null;if(t.type=="pagebeforechange"){if(i.options._jqmrouter_bC){return}l={isString:typeof i.toPage==="string",deferred:e.Deferred(),toPage:i.toPage};s=!l.isString?i.toPage:null}if(t.type in{pagebeforehide:true,pagehide:true,pageremove:true}){u=n}else{u=r}a=!this.conf.ajaxApp?u.hash:u.pathname+u.search+u.hash;if(a.length==0){u=null;if(!this.documentEvts[t.type]&&s){u=e(s).jqmData("url")}else{u=e.mobile.firstPage.jqmData("url")}if(u){u=e.mobile.path.parseUrl("#"+u);a=!this.conf.ajaxApp?u.hash:u.pathname+u.search+u.hash}}if(a.length==0){return}var c=false;e.each(this.routes[t.type],function(e,n){var r,u;if(l&&n.step!="all"){n.step=n.step||"page";if(l.isString&&n.step=="page"||!l.isString&&n.step!="page"){return}}if(r=a.match(o.routesRex[e])){if(typeof n.handler=="function"){u=n.handler}else if(typeof o.userHandlers[n.handler]=="function"){u=o.userHandlers[n.handler]}if(u){try{if(l&&i){i.bCDeferred=l.deferred}u.apply(o.userHandlers,[t.type,r,i,s,t]);c=true}catch(f){o.debug(f)}}}if(c&&o.conf.firstMatchOnly){return false}});if(!c&&this.conf.defaultHandler&&this.defaultHandlerEvents[t.type]){var h;if(typeof this.conf.defaultHandler=="function"){h=this.conf.defaultHandler}else if(typeof this.userHandlers[this.conf.defaultHandler]=="function"){h=this.userHandlers[this.conf.defaultHandler]}try{h.apply(this.userHandlers,[t.type,i,s,t])}catch(p){this.debug(p)}}if(l&&t.isDefaultPrevented()){l.deferred.done(function(){var t=l.toPage===i.toPage?{_jqmrouter_handled:true,_jqmrouter_bC:true}:null;e.mobile.changePage(i.toPage,e.extend({allowSamePageTransition:i.options.allowSamePageTransition,changeHash:i.options.changeHash,data:i.options.data,dataUrl:i.options.dataUrl,pageContainer:i.options.pageContainer,reloadPage:i.options.reloadPage,reverse:i.options.reverse,role:i.options.role,showLoadMsg:i.options.showLoadMsg,transition:i.options.transition,type:i.options.type},t))})}},_detachEvents:function(){if(this._eventData){e(document).off(this._eventData.events,this._eventData.selectors,this._eventData.handler)}if(this._docEventData){e(document).off(this._docEventData.events,this._docEventData.handler)}},destroy:function(){this._detachEvents();this.routes=this.routesRex=null},getParams:function(t){if(!t){return null}var n={},r;var i=t.slice(t.indexOf("?")+1).split("&");e.each(i,function(e,t){r=t.split("=");r[0]=decodeURIComponent(r[0]);if(n[r[0]]){if(!(n[r[0]]instanceof Array)){n[r[0]]=[n[r[0]]]}n[r[0]].push(decodeURIComponent(r[1]))}else{n[r[0]]=decodeURIComponent(r[1])}});if(e.isEmptyObject(n)){return null}return n}})});return{}})